version: 1
plugins:
  - source: file
    path: ../../plugins/rule-loom-core
  - source: file
    path: ../../plugins/rule-loom-plugin-http
inputs:
  - type: http
    config: {}
    triggers:
      - type: httpRoute
        method: post
        path: /module
        flow: apply-discount
closures:
  - type: module
    module: ../modules/custom-closures.js
flows:
  - name: apply-discount
    steps:
      - closure: core.assign
        parameters:
          target: payload
          value: "${request.body}"
      - closure: compute-discount
        parameters:
          amount: "${state.payload.amount}"
          rate: "${state.payload.rate}"
      - closure: core.respond
        parameters:
          status: 200
          body:
            total: "${state.discountedTotal}"
