version: 1
plugins:
  - source: github
    repo: daniellmorris/RuleLoom
    ref: main
    path: plugins/rule-loom-core
    name: Core
    build:
      - npm install
      - npm run build
  - source: github
    repo: daniellmorris/RuleLoom
    ref: main
    path: plugins/rule-loom-plugin-http
    name: HTTP
    build:
      - npm install
      - npm run build
  - source: github
    repo: daniellmorris/RuleLoom
    ref: main
    path: plugins/rule-loom-plugin-scheduler
    name: Scheduler
    build:
      - npm install
      - npm run build
  - source: github
    repo: daniellmorris/RuleLoom
    ref: main
    path: plugins/rule-loom-plugin-websocket
    name: WebSocket
    build:
      - npm install
      - npm run build
inputs:
  - type: scheduler
    triggers:
      - flow: toggle-ha-switch
        $meta:
          id: 3yh4s1uh
          x: 700.4338046778479
          "y": 941.8155663638621
        interval: 1h
        runtime:
          targetEntity: switch.third_reality_inc_3rsp019bz_2
  - type: http
    config:
      basePath: /api
      corsOrigins: http://localhost:4173, http://localhost
      corsMethods: GET, POST
      corsAllowedHeaders: Authorization, Content-Type
    triggers:
      - flow: ha.get-entities
        method: get
        path: /entities
        $meta:
          id: http-trigger-entities
          x: 937.264315951729
          "y": 635.2344261316908
  - type: websocket
    config:
      url: ws://dmserver:8123/api/websocket
      connectMessages:
        - type: auth
          access_token: >-
            eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI5YjA2NGIxNzNiMjc0MTk1OGQ2NTAwNDI2Y2Q1NTMzYSIsImlhdCI6MTc2MzY1Mzg1MSwiZXhwIjoyMDc5MDEzODUxfQ.OjNMR4MKTzjYDpdR7-1E5kZez8Wtue6R8sJCjBwDpDo
        - id: 1
          type: subscribe_events
          event_type: state_changed
    triggers:
      - flow: ha.ws-events
        json: true
closures:
  - type: flow
    name: ha.toggle-switch
    description: Toggle a Home Assistant switch via REST API.
    steps:
      - closure: http.request
        assign: lastHaResponse
        parameters:
          method: POST
          baseUrl: http://dmserver:8123
          url: /api/services/${parameters.domain}/${parameters.service}
          headers:
            Authorization: >-
              Bearer
              eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI5YjA2NGIxNzNiMjc0MTk1OGQ2NTAwNDI2Y2Q1NTMzYSIsImlhdCI6MTc2MzY1Mzg1MSwiZXhwIjoyMDc5MDEzODUxfQ.OjNMR4MKTzjYDpdR7-1E5kZez8Wtue6R8sJCjBwDpDo
          body:
            entity_id: ${parameters.entityId}
        $meta:
          id: fsvfj5m9
      - closure: core.log
        parameters:
          level: info
          message: "HA toggle status ${state.lastHaResponse.status}: ${state.lastHaResponse.body}"
        $meta:
          id: co9vony7
    $meta:
      id: z4z5y9eh
      x: 1000
      "y": 1000
      disconnected: []
flows:
  - name: toggle-ha-switch
    steps:
      - closure: ha.toggle-switch
        parameters:
          domain: switch
          service: toggle
          entityId: ${runtime.targetEntity}
        $meta:
          id: z3luwpes
          x: 1582
          "y": 904
    $meta:
      id: kfh1khdo
      x: 1000
      "y": 1000
      disconnected: []
  - name: ha.get-entities
    steps:
      - closure: http.request
        assign: lastHaResponse
        parameters:
          method: GET
          baseUrl: http://dmserver:8123
          url: /api/states
          headers:
            Authorization: >-
              Bearer
              eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI5YjA2NGIxNzNiMjc0MTk1OGQ2NTAwNDI2Y2Q1NTMzYSIsImlhdCI6MTc2MzY1Mzg1MSwiZXhwIjoyMDc5MDEzODUxfQ.OjNMR4MKTzjYDpdR7-1E5kZez8Wtue6R8sJCjBwDpDo
        $meta:
          id: ha-http-entities
          x: 1529.6393977624346
          "y": 638.8871836447433
      - closure: core.respond
        parameters:
          status: ${state.lastHaResponse.status}
          body: ${state.lastHaResponse.body}
        $meta:
          id: ha-http-respond
          x: 1804.5337896689537
          "y": 625.9093368165385
    $meta:
      id: ha-flow-entities
      x: 1280
      "y": 640
      disconnected: []
  - name: ha.ws-events
    steps:
      - closure: core.log
        parameters:
          level: info
          message: "HA WS event: ${state.websocket.message.type}"
        $meta:
          id: ha-ws-log
    $meta:
      id: ha-flow-ws-events
      x: 1280
      "y": 320
      disconnected: []
dashboards:
  config:
    defaultId: main
    currentId: main
    grid:
      cols: 12
      rowHeight: 120
      gap: 12
  list:
    - id: main
      name: Main Dashboard
      layout:
        content:
          - type: FlexColumn
            props:
              gap: 12
              children:
                - type: TableWidget
                  props:
                    title: Entities
                    endpoint: http://localhost:3000/api/entities
                    columns: entity_id,state
